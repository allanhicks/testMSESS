library(MASS)

randWalkSelex.fn <- function(pars) {
    #calculates the selectivity from the random walk parameters in SS (option 17)
    #-1000 means to set equal to 0
    #assumes that this is all pars from age 0 to max age
    
    logS <- rep(NA,length(pars))
    logS[1] <- 0 #first value is never estimated (age 0)
    for(a in 2:length(pars)) {
        ifelse(pars[a] == -1000, logS[a] <- 0, logS[a] <- logS[a-1]+pars[a])
    }
    selex <- exp(logS-max(logS))
    selex[pars== -1000] <- 0
    return(selex)
}

#pure random
#sigma 0.2
basePars <- scan()
-1000.00000000
0.000000000000
3.53140127421
1.42085186247
0.480144548105
0.138635622204
0.341779623757
0.000000000000
0.000000000000
0.000000000000

# selparm_dev: pure Random
devs <- matrix(scan(),nrow=5,byrow=T)
 -2.53681345441e-006 1.12512154402e-005 3.83369808628e-005 3.49032855667e-005 4.71501267185e-006 0.000102130749911 6.61401256608e-006 -1.06373371551e-005 6.25725189014e-005 -0.000629988124389 -7.62015548101e-005 0.00708131659475 -0.00638012356747 0.000625217737188 -0.000184586520154 -0.201166201929 0.000753929876158 4.12597977721e-005 0.000134241534944 -0.00439306456200 0.000125545005991 -8.03796695159e-006 0.00184948970560 0.00201669593191 0.000259490816878 0.0164773730029 -0.000120416531631 0.000227460357056 0.00407752016678 0.00112143238491 0.0129328820345 0.00408551090221 0.00644069238913 0.0437831372466 0.0187120811316 0.00152551255941 0.00167808169194 3.83615131447e-005 0.00537930493829 0.000116579597865 0.0110286822199 0.0176998165528 -0.00201814999438 -0.00276968562448 0.0488119013089 -0.00433867628572 0.0148140629333
 -5.05705967591e-006 0.000781830219490 0.000934378579480 0.00327701065197 0.00244457705012 0.000549290259499 0.00400107434893 0.000341513651803 -0.000364631430829 -0.0718529127749 0.00572284732061 -0.134616299455 0.00387117291464 0.0786834006376 0.0224106527624 -0.148181274948 -0.0433111867975 0.00603691059980 0.00554686108083 0.00223119530001 0.0484970321804 0.000903736523023 -0.00638713908286 0.00269343885215 -0.0248223617823 -0.00577525471386 0.0519640633421 0.0322265666451 0.0128474660154 0.0213199536550 -0.152295369019 0.111927108106 0.0421697530474 -0.0678926006577 0.0219563667695 0.0969529723746 0.0453414608745 0.0472316983095 0.0152065845920 0.0667306872728 -0.0627993241976 0.00381699596131 0.0136080625974 0.0649766667403 -0.0409501247060 -0.0191696696728 -0.0587798655818
 -1.03581121884e-005 0.00255483698465 0.00414226193294 0.00973271680177 0.0196035762328 0.00860409729475 0.00524679122260 0.0167794119438 0.00132732733810 -0.0738307249084 0.0140088677686 -0.0407653759316 -0.00117032217967 -0.0336504925573 -0.0532243539874 -0.0775259042957 -0.0273158718793 0.0516077500210 0.00920237688604 0.0105898287663 -0.0558842006319 0.0313736038462 -0.00223281858359 -0.0274737834775 -0.0170424029529 -0.154090217807 -0.00709405642592 0.00415176717901 0.0631356079351 0.0324725889288 -0.0282486997864 -0.0514001097593 -0.0600118522272 -0.0172558607678 0.00846549524969 0.127775134356 0.0920345160759 0.0893542934985 0.0632598777515 0.0771295214866 0.0153871753809 -0.0583830919181 -0.0195579710560 -0.0355263951603 0.116654761390 -0.0438390310595 0.0109397351262
 -0.000240831635409 0.00392151084183 0.00661271014287 0.0179559980932 0.0329996726271 0.0288191213565 0.0145571398128 0.0178677447799 0.0307837498359 -0.0491551908065 -0.0298904127983 -0.0499796835423 0.0198613791000 -0.0354653232158 0.0138844628370 0.000862100967415 0.0271396164985 0.0279043631527 0.0165889731693 -0.0307836986533 -0.0391586315977 0.00735807027696 0.0371189010633 -0.0268206636015 -0.0106099280858 -0.0125417490555 -0.0741280843601 -0.00537008608074 0.0175859106983 0.0858011046368 -0.0124331513640 -0.0191496654808 0.0440246387841 -0.0406285444233 0.0287291363406 -0.0771365987244 0.0391555772592 0.0534124246114 -0.0599004034035 0.0331338098216 0.0128582056087 -0.0106652686683 0.0262882439565 0.00500146788338 -0.0762747768916 -0.0221063060519 0.0322128288774
 -0.00101650369965 0.00377168607897 0.00767116365785 0.0224393179156 0.0463721133366 0.0397672048675 0.0314978646598 0.0288734991741 0.0321572047930 0.000436642230415 0.0511293144823 0.0237756994357 -0.0173221954777 -0.0114423684641 0.0608432642400 0.0224798272371 0.0216959393933 0.0531884807935 0.0107518225956 -0.0457083330525 -0.0166102907889 0.0107587020508 0.0364605255015 0.00140536370567 0.00154826441923 -0.0161034411873 0.0269494929818 -0.0458064523955 0.0229363915809 -0.00407662815585 0.0478969315052 0.00981992983751 -0.0709681354699 -0.0198362309801 0.0352346417933 -0.0827738291104 -0.0629158832500 -0.0302851897177 -0.00497029242884 -0.0374343918534 -0.0636665218501 -0.00273728456312 -0.0294066621242 0.0401271745959 -0.0765088080284 -0.0606711116446 0.0102724100419



#sigma 0.05
basePars <- scan()
-1000.00000000
0.000000000000
3.13821392741
1.39124813716
0.486143129779
0.169798932811
0.242899302450
0.000000000000
0.000000000000
0.000000000000

# selparm_dev: pure Random
devs <- matrix(scan(),nrow=5,byrow=T)
 -2.14233091711e-007 1.40126035042e-006 4.66060576976e-006 4.95793556610e-006 6.54995794491e-007 1.38641942371e-005 6.12675215450e-007 -1.59970701930e-006 7.47792335432e-006 -6.49618852986e-005 6.10478559810e-005 0.000221492745148 0.000139278260846 6.34022597268e-005 7.40307532272e-005 -0.0432431314246 6.40782739509e-005 7.56429919768e-006 1.99352320465e-005 -0.000152377307211 1.01705100857e-005 -4.00813277679e-007 0.000250054692732 0.000167370617577 1.99131836567e-005 0.000795964315881 5.20629215828e-006 2.69684761083e-005 0.000923439213016 0.000427304797537 0.000605223227527 0.000774104083565 0.000868719047098 0.00377053095845 0.00629788388888 0.000235184245776 0.000326158351712 1.73542738118e-005 0.000792565180364 3.51427897360e-005 0.000836350118886 0.00198361522702 -0.000121384741528 0.00650219896474 0.00697607123972 0.00856033661442 0.00169187458237
 7.34980590167e-007 6.04648318152e-005 7.48024974477e-005 0.000295938734281 0.000248506855103 4.77653780955e-005 0.000320604225193 2.05119815035e-005 -3.55369500582e-005 -0.00767673184270 0.000676767382215 -0.0273530722898 0.000865209432686 0.00496395879954 0.00171775340280 -0.0474555349541 -0.00901811307478 0.000538243536315 0.000448312441616 0.000218100892226 -0.00141943665455 7.46418870960e-005 -0.000249789734490 -0.00260414398901 -0.00193946443962 -0.000985135621930 0.00414854696958 0.00214843843706 0.00195721227372 0.00965515599311 -0.0242829728743 0.0121917957230 0.00361341311212 -0.0133405561394 0.0109996743828 0.0581948773747 0.00459636853027 0.00832987414148 0.00152154190722 0.0166694039099 -0.00268575909826 -0.0127400065303 0.00928258744481 0.0113550113024 0.0155935765701 -0.00607227858188 -0.0229715208305
 3.53011708754e-007 0.000192667645047 0.000312465411326 0.000826917901540 0.00189007226075 0.000711437306100 0.000402783904336 0.00132407734555 5.99679291220e-005 -0.00833750360463 0.00617656447728 -0.0227796824772 0.00473951458838 -0.00249825053061 -0.00513035106093 -0.0409257803937 -0.00472979480089 0.0263184758348 0.000800069632254 0.000570832786742 -0.00913591965210 0.00782832643383 8.95265322036e-005 -0.00450952571063 -0.00471260682492 -0.0258651497604 0.000586606206728 -0.00454732178898 0.00801877423982 0.0110843853803 -0.00905546361933 -0.0110564111829 -0.0107916896817 -0.0205048304002 0.0203030619048 0.0502496680970 0.0422364621928 0.0152329953260 0.00390684538004 0.0173408362410 -0.000518400440123 -0.0160895663099 -0.00154822658029 -0.00453402464841 0.0259971511288 -0.0375227421252 -0.00240775595426
 -1.71449844970e-005 0.000285153181441 0.000490156188162 0.00144617404820 0.00294414680214 0.00226679213797 0.00107778523685 0.00138348837500 0.00228296572931 -0.00697559933779 0.00395703336026 -0.0140113316392 0.00643832214195 -0.00565701450612 0.00123959992620 -0.00962849077000 -0.000342000940023 0.0257755925905 0.00841061871090 -0.00201165576794 -0.00845425913423 0.00629886291042 0.0151556333464 -0.00446975867471 -0.00421312038681 -0.0149120386167 -0.00716511850922 -0.00509182737986 0.0166717391976 0.0166468130295 -0.00679491854662 -0.00485243207542 -0.00217400116398 -0.0257227554062 0.0287819087093 -0.0115586863284 0.0175373388602 0.0175765287968 -0.00763444082326 0.00991752887111 -0.00125776017667 -0.00539302852458 0.000711215389620 0.0181946623611 -0.0372886003298 -0.0356768163112 0.0158125043145
 -7.26479242701e-005 0.000263540215823 0.000551080727377 0.00172347659621 0.00374658550033 0.00291601139599 0.00219863272503 0.00209772375431 0.00233378475549 -0.00109546899156 0.0107701586043 -0.00695522299984 -0.000610482893206 -0.00398031595869 0.0147704021755 -0.00695020475685 0.00423973320132 0.0272720662300 0.00855916702697 -0.00546950677200 -0.00695142540779 0.00655093915405 0.0152808607603 0.00220979815602 -0.00331955799858 -0.0149846425093 0.0100371911192 -0.00770273935008 0.0171181718577 0.0101571589604 0.00123730391227 -0.00247785913725 -0.0185592116494 -0.0144460872188 0.0317445442730 -0.0327376493591 0.00353972527240 0.00362023382734 0.00282659355518 0.00376658189227 -0.0219080971697 -0.00479834353422 -0.00930611459687 0.0207924992475 -0.0395528369538 -0.0233061375445 0.0148605456866


#Pure Random with alogistic transformation to keep parameters within bounds
selparmMax <- 9
selparmMin <- -5
selex <- matrix(NA,nrow=ncol(devs),ncol=length(basePars))
indsEst <- 3:7
for(i in 1:ncol(devs)) {
    sp <- basePars
    temp <- log((selparmMax-selparmMin+0.0000002)/(sp[indsEst]-selparmMin+0.0000001)-1)/(-2);   # transform the parameter
    temp <- temp + devs[,i]
    sp[indsEst] <- selparmMin+(selparmMax-selparmMin)/(1+exp(-2*temp));
    selex[i,] <- randWalkSelex.fn(sp)
}
#above reproduces SS3
#now change selex into future
#par(mfrow=c(2,3))
#for(i in 1:nrow(devs)){plot(density(devs[i,]),main=i)}

nForeYrs <-50

#sigDevs <- apply(devs,1,sd)
#newDevs <- matrix(NA,nrow=nrow(devs),ncol=nForeYrs)
#for(i in 1:nrow(devs)) {
#    newDevs[i,] <- rnorm(nForeYrs,0,sigDevs[i])
#}
covDevs <- cov(t(devs))
newDevs <- t(mvrnorm(nForeYrs, rep(0,ncol(covDevs)), covDevs))

allDevs <- cbind(devs,newDevs)
colnames(allDevs) <- 1966:(1966-1+ncol(allDevs))

selex <- matrix(NA,nrow=ncol(allDevs),ncol=length(basePars),dimnames=list(colnames(allDevs),0:(length(basePars)-1)))
indsEst <- 3:7
for(i in 1:ncol(allDevs)) {
    sp <- basePars
    temp <- log((selparmMax-selparmMin+0.0000002)/(sp[indsEst]-selparmMin+0.0000001)-1)/(-2);   # transform the parameter
    temp <- temp + allDevs[,i]
    sp[indsEst] <- selparmMin+(selparmMax-selparmMin)/(1+exp(-2*temp));
    selex[i,] <- randWalkSelex.fn(sp)
}
persp(y=as.numeric(colnames(selex)),x=as.numeric(rownames(selex)),z=selex,theta=50,phi=39,ylab="Age",xlab="Year",zlab="Selectivity")

selexNew <- selex
selexNew[as.character(1966:2012),] <- NA
par(new=T)
persp(y=as.numeric(colnames(selexNew)),x=as.numeric(rownames(selexNew)),z=selexNew,theta=50,phi=39,ylab="Age",xlab="Year",zlab="Selectivity",col="green")



randWalkSelex.fn <- function(pars,devs=NULL,logisticTransform=NULL) {
    #calculates the selectivity from the random walk parameters in SS (option 17)
    #-1000 means to set equal to 0
    #assumes that this is all pars from age 0 to max age
    #assumes that this is all devs from age 0 to max age, so put in non-estimated devs as 0
    #logisticTransform is either NULL or a vector with min and max bounds on parameter
    
    if(!is.null(logisticTransform) & !is.null(devs)) {
        if(length(logisticTransform) != 2) stop("logisticTransform in randWalkSelex.fn must be NULL or length 2\n")
        indNotNeg1000 <- pars != -1000
        pars[indNotNeg1000] <- log((logisticTransform[2]-logisticTransform[1]+0.0000002)/(pars[indNotNeg1000]-logisticTransform[1]+0.0000001)-1)/(-2);   # transform the parameter
        if(length(pars) != length(devs)) {stop("devs need to be a vector with same length as pars in randWalkSelex.fn\n")}
        pars <- pars + devs
        pars[indNotNeg1000] <- logisticTransform[1]+(logisticTransform[2]-logisticTransform[1])/(1+exp(-2*pars[indNotNeg1000]));
    }
    logS <- rep(NA,length(pars))
    logS[1] <- 0 #first value is never estimated (age 0)
    for(a in 2:length(pars)) {
        ifelse(pars[a] == -1000, logS[a] <- 0, logS[a] <- logS[a-1]+pars[a])
    }
    selex <- exp(logS-max(logS))
    selex[pars== -1000] <- 0
    return(selex)
}


selex <- matrix(NA,nrow=ncol(allDevs),ncol=length(basePars),dimnames=list(colnames(allDevs),0:(length(basePars)-1)))
for(i in 1:ncol(allDevs)) {
    selex[i,] <- randWalkSelex.fn(basePars,devs=c(0,0,allDevs[,i],0,0,0),logisticTransform=c(selparmMin,selparmMax))
}





#random walk
basePars <- scan()
-1000.00000000
0.000000000000
3.02581722826
0.300990020809
0.688897781695
0.375000066724
2.26702204358
0.000000000000
0.000000000000
0.000000000000


# selparm_dev: Random Walk
devs <- matrix(scan(),nrow=5,byrow=T)
 1.30400934495e-009 -1.25999521554e-005 -3.27101896254e-005 -7.42865026435e-005 -0.000113052654983 -0.000110780740716 -0.000262797239913 -0.000239499776452 -0.000100818908663 -0.000385939611226 0.000759803131803 -0.00645945379655 -0.0204518988169 -0.0562510691265 -0.0588192199987 -0.0710086734691 0.0429297932883 0.0370868717146 0.0365673737261 0.0357769274064 0.0294947836313 0.0292030456460 0.0292204099064 0.0259034184814 0.0236102660195 0.0234651643383 0.0158510612319 0.0159812310650 0.0159088253064 0.0141382159117 0.0133065051176 0.00788815278197 0.00481125664844 0.00146034951765 -0.0214276545862 -0.00728958014716 -0.00810986320179 -0.00845562349473 -0.00845727653834 -0.00932019070742 -0.00938391156138 0.00654747717937 -0.00642676267592 -0.00494031414852 0.00982492906856 -0.0376048293275 0.00312603168529
 -7.27270688117e-010 -0.000148270099766 -0.000791816476504 -0.00123588068345 -0.00300453576779 -0.00456819332419 -0.00457808594514 -0.00686555661847 -0.00546538279911 -6.10584727667e-007 0.0388107169039 -0.00159247243774 0.128061660915 0.0630215129303 -0.0448310702030 -0.0924003631621 0.0232311437403 0.0459035073457 0.0363809028831 0.0292886065122 0.0163169653888 -0.00259050830898 -0.00325887238970 0.000839767446051 0.00143254459658 0.0323398794077 0.0408271464161 -0.0252451433649 -0.0453470893705 -0.0552938762217 -0.102619309433 0.157365448371 -0.0202864211680 -0.0760388600055 0.0593545517388 0.0876946136784 0.0245983814636 -0.000275758980731 -0.0171805840251 -0.0220159078252 -0.0772448798506 -0.00211540302038 0.0134772579489 0.0166495695770 -0.0388868326607 -0.0263910428576 -0.0347474314896
 -7.52361017931e-009 -0.000271770263202 -0.00137673743742 -0.00254794121681 -0.00537364060131 -0.0109494304350 -0.0124153949385 -0.0142787406988 -0.0146650473143 -0.00589830530906 0.0426690024568 -0.0215758235856 0.0299826482807 -0.0451311946214 -0.0291767931149 -0.00756262700619 0.0392927199669 0.0474328336928 -0.0117885826722 -0.0242509942311 -0.0466661493839 0.0338047525694 -0.0367529761330 -0.0399973740747 -0.00632845388332 -0.0585370121206 0.0735639545419 0.0735893470123 0.0593151308889 -0.0148475560588 -0.0734830734936 -0.00476573507827 -0.00140446071943 0.0245743134366 0.0624052971058 0.0861797417105 -0.00903053723897 0.00909662745190 -0.0384762305220 -0.00290694459031 -0.0703300716708 -0.0657990724338 0.0161127761652 0.0214546185865 0.0944436554581 -0.0884704675628 0.0279809167702
 1.95455029939e-009 -0.000375746851256 -0.00198142825569 -0.00380059532771 -0.00884385648678 -0.0171413493886 -0.0230867691560 -0.0263912467133 -0.0249427351661 -0.0195360942484 0.0142098208128 0.00230882532970 0.0731338457409 -0.0265177020651 0.0391505840717 -0.00806770263227 0.0450920051101 0.000841850363567 -0.0366879058423 -0.0311530621828 -0.0106618075018 0.0520144480900 0.00636834219342 -0.0267055496093 0.00830362676770 -0.0495821928148 -0.0168163596971 0.0541400491932 0.0515702994612 0.0426420888925 -0.0629988335664 -0.0109416208821 0.0177100263998 -0.0629182039243 0.0433766484913 -0.0769277857946 0.0841442010838 0.0235834295351 -0.0974287882673 0.0735227048286 0.00106331968998 0.00868756857239 0.0155338114419 -0.0184889726676 -0.0961154689968 0.0177524465320 0.0840167161316
 -5.09771069801e-009 -0.000409497586118 -0.00243129303631 -0.00488540075244 -0.0116769935289 -0.0249428548386 -0.0332039349569 -0.0401291389249 -0.0397099071317 -0.0313543620337 0.0173597437727 -0.0536670040014 -0.0518180635826 0.0132518149999 0.0599039639825 -0.0346315159387 -0.000377104621087 0.0209682373848 -0.0457795864752 -0.0491719448344 0.0164333637322 0.0541727604033 0.00625717225894 -0.0262209251149 0.0335836168533 -0.0350796363784 0.00469460713405 -0.0465836288494 0.0175306889489 0.00603272105055 0.0150214310234 -0.0357377905991 -0.0419393036360 0.0375638384436 0.0562512414492 -0.117143545753 0.0243170214678 0.0327417874833 0.0209781230965 -0.0256747017786 -0.0312947622726 0.0175136063853 0.0188230888004 0.0358658143257 -0.0871334530668 0.0184799789149 0.0617030049961

#Random walk with alogistic transformation to keep parameters within bounds
selparmMax <- 9
selparmMin <- -5
selex <- matrix(NA,nrow=ncol(devs),ncol=length(basePars))
indsEst <- 3:7
spnew <- basePars
for(i in 1:ncol(devs)) {
    sp <- spnew
    temp <- log((selparmMax-selparmMin+0.0000002)/(sp[indsEst]-selparmMin+0.0000001)-1)/(-2);   # transform the parameter
    temp <- temp + devs[,i]
    spnew[indsEst] <- selparmMin+(selparmMax-selparmMin)/(1+exp(-2*temp));
    selex[i,] <- randWalkSelex.fn(spnew)
}
#above reproduces SS3
#now change selex into future
#par(mfrow=c(2,3))
#for(i in 1:nrow(devs)){plot(density(devs[i,]),main=i)}

nForeYrs <- 60

#sigDevs <- apply(devs,1,sd)
#newDevs <- matrix(NA,nrow=nrow(devs),ncol=nForeYrs)
#for(i in 1:nrow(devs)) {
#    newDevs[i,] <- rnorm(nForeYrs,0,sigDevs[i])
#}
library(MASS)
covDevs <- cov(t(devs))
newDevs <- t(mvrnorm(nForeYrs, rep(0,ncol(covDevs)), covDevs))

allDevs <- cbind(devs,newDevs)
colnames(allDevs) <- 1966:(1966-1+ncol(allDevs))

selex <- matrix(NA,nrow=ncol(allDevs),ncol=length(basePars),dimnames=list(colnames(allDevs),0:(length(basePars)-1)))
indsEst <- 3:7
spnew <- basePars
for(i in 1:ncol(allDevs)) {
    sp <- spnew
    temp <- log((selparmMax-selparmMin+0.0000002)/(sp[indsEst]-selparmMin+0.0000001)-1)/(-2);   # transform the parameter
    temp <- temp + allDevs[,i]
    spnew[indsEst] <- selparmMin+(selparmMax-selparmMin)/(1+exp(-2*temp));
    selex[i,] <- randWalkSelex.fn(spnew)
}
persp(y=as.numeric(colnames(selex)),x=as.numeric(rownames(selex)),z=selex,theta=50,phi=39,ylab="Age",xlab="Year",zlab="Selectivity")

selexNew <- selex
selexNew[as.character(1966:2012),] <- NA
par(new=T)
persp(y=as.numeric(colnames(selexNew)),x=as.numeric(rownames(selexNew)),z=selexNew,theta=50,phi=39,ylab="Age",xlab="Year",zlab="Selectivity",col="green")
